<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android SQLite 源码分析 | Wqy&#39;s Home Page | Impossible is nothing.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#9C27B0">
  
  
  <meta name="keywords" content="SQLite">
  <meta name="description" content="SQL 语句的执行过程我们在使用 SQLiteDatabase 的时候，一般都是使用它的提供的封装好的方法，那么这些方法的究竟做了哪些事呢？
SQLiteDatabase从最简单的insert(String table, String nullColumnHack, ContentValues values)方法来研究。在 SQLiteDatabase.java 文件中找到这个方法，非常简单，它简">
<meta property="og:type" content="article">
<meta property="og:title" content="Android SQLite 源码分析">
<meta property="og:url" content="http://WqyJh.github.io/2016/12/22/Android-SQLite-源码分析/index.html">
<meta property="og:site_name" content="Wqy's Home Page">
<meta property="og:description" content="SQL 语句的执行过程我们在使用 SQLiteDatabase 的时候，一般都是使用它的提供的封装好的方法，那么这些方法的究竟做了哪些事呢？
SQLiteDatabase从最简单的insert(String table, String nullColumnHack, ContentValues values)方法来研究。在 SQLiteDatabase.java 文件中找到这个方法，非常简单，它简">
<meta property="og:image" content="http://oih52y89x.bkt.clouddn.com/sqlite1.png">
<meta property="og:updated_time" content="2016-12-22T11:49:12.412Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android SQLite 源码分析">
<meta name="twitter:description" content="SQL 语句的执行过程我们在使用 SQLiteDatabase 的时候，一般都是使用它的提供的封装好的方法，那么这些方法的究竟做了哪些事呢？
SQLiteDatabase从最简单的insert(String table, String nullColumnHack, ContentValues values)方法来研究。在 SQLiteDatabase.java 文件中找到这个方法，非常简单，它简">
<meta name="twitter:image" content="http://oih52y89x.bkt.clouddn.com/sqlite1.png">
  
    <link rel="alternative" href="/atom.xml" title="Wqy&#39;s Home Page" type="application/atom+xml">
  
  <meta name="summary" content="Stay hungry, stay foolish!">

  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div style="display:none">
    <img src="/img/logo.jpg" alt="分享图标" />
  </div>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">wqy</h5>
        <a href="mailto:781345688@qq.com" title="781345688@qq.com" class="mail">781345688@qq.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              主页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              Archives
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              Tags
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/categories"  >
              <i class="icon icon-lg icon-categories"></i>
              Categories
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/WqyJh" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>Wqy&#39;s Home Page &copy; 2016</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Android SQLite 源码分析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">Android SQLite 源码分析</h1>
    <h5 class="subtitle">
        
            <time datetime="2016-12-22T11:04:58.000Z" itemprop="datePublished" class="page-time">
  2016-12-22
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-Android-SQLite-源码分析" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQLite/">SQLite</a></li></ul>


    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SQL-语句的执行过程"><span class="post-toc-number">1.</span> <span class="post-toc-text">SQL 语句的执行过程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SQLiteDatabase"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">SQLiteDatabase</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SQLiteStatment"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">SQLiteStatment</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SQLiteSession"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">SQLiteSession</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#SQLiteConnection"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">SQLiteConnection</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DatabaseUtils-和-Cursor-接口（不重要）"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">DatabaseUtils 和 Cursor 接口（不重要）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PreparedStatment"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">PreparedStatment</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#小结（附图）"><span class="post-toc-number">2.</span> <span class="post-toc-text">小结（附图）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#SQLiteSession-Documentation-翻译"><span class="post-toc-number">3.</span> <span class="post-toc-text">SQLiteSession Documentation 翻译</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#关于数据库的会话"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">关于数据库的会话</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#所有权和并发保证"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">所有权和并发保证</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#事务"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">事务</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#数据库连接"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">数据库连接</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#响应"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">响应</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#可重入（Reentrance）"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">可重入（Reentrance）</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#（未完待续～）"><span class="post-toc-number">4.</span> <span class="post-toc-text">（未完待续～）</span></a></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="SQL-语句的执行过程"><a href="#SQL-语句的执行过程" class="headerlink" title="SQL 语句的执行过程"></a>SQL 语句的执行过程</h1><p>我们在使用 SQLiteDatabase 的时候，一般都是使用它的提供的封装好的方法，那么这些方法的究竟做了哪些事呢？</p>
<h2 id="SQLiteDatabase"><a href="#SQLiteDatabase" class="headerlink" title="SQLiteDatabase"></a>SQLiteDatabase</h2><p>从最简单的<code>insert(String table, String nullColumnHack, ContentValues values)</code>方法来研究。<br>在 SQLiteDatabase.java 文件中找到这个方法，非常简单，它简单粗暴地调用了<code>insertWithOnConflict()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">insert</span><span class="params">(String table, String nullColumnHack, ContentValues values)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> insertWithOnConflict(table, nullColumnHack, values, CONFLICT_NONE);</div><div class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"Error inserting "</span> + values, e);</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">insertWithOnConflict</span><span class="params">(String table, String nullColumnHack,</span></span></div><div class="line">         ContentValues initialValues, <span class="keyword">int</span> conflictAlgorithm) &#123;</div><div class="line">     acquireReference();</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// 将参数拼接成 sql 语句，这里只是添加了 table</span></div><div class="line">      <span class="comment">// 大概是这个样子 INSERT INTO table(</span></div><div class="line">      <span class="comment">// 那个 CONFLICT_VALUES 先不管</span></div><div class="line">         StringBuilder sql = <span class="keyword">new</span> StringBuilder();</div><div class="line">         sql.append(<span class="string">"INSERT"</span>);</div><div class="line">         sql.append(CONFLICT_VALUES[conflictAlgorithm]);</div><div class="line">         sql.append(<span class="string">" INTO "</span>);</div><div class="line">         sql.append(table);</div><div class="line">         sql.append(<span class="string">'('</span>);</div><div class="line"></div><div class="line">         Object[] bindArgs = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">int</span> size = (initialValues != <span class="keyword">null</span> &amp;&amp; initialValues.size() &gt; <span class="number">0</span>)</div><div class="line">                 ? initialValues.size() : <span class="number">0</span>;</div><div class="line">         <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">             bindArgs = <span class="keyword">new</span> Object[size];</div><div class="line">             <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">             <span class="comment">// initialValues 的 keySet 是对应的 column</span></div><div class="line">             <span class="comment">// 将 column 拼接上去，并按 column 的顺序</span></div><div class="line">             <span class="comment">// 将参数取出保存到 bindArgs</span></div><div class="line">             <span class="comment">// 执行完这个循环就成了这样</span></div><div class="line">             <span class="comment">// INSERT INTO table(column1,column2,...</span></div><div class="line">             <span class="keyword">for</span> (String colName : initialValues.keySet()) &#123;</div><div class="line">                 sql.append((i &gt; <span class="number">0</span>) ? <span class="string">","</span> : <span class="string">""</span>);</div><div class="line">                 sql.append(colName);</div><div class="line">                 bindArgs[i++] = initialValues.get(colName);</div><div class="line">             &#125;</div><div class="line">             <span class="comment">// 添加 VALUES 子句，用'?'对参数占位</span></div><div class="line">             <span class="comment">// 执行完就成了这样</span></div><div class="line">             <span class="comment">// INSERT INTO table(column1,column2,...) VALUES (?,?,...)</span></div><div class="line">             sql.append(<span class="string">')'</span>);</div><div class="line">             sql.append(<span class="string">" VALUES ("</span>);</div><div class="line">             <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">                 sql.append((i &gt; <span class="number">0</span>) ? <span class="string">",?"</span> : <span class="string">"?"</span>);</div><div class="line">             &#125;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             sql.append(nullColumnHack + <span class="string">") VALUES (NULL"</span>);</div><div class="line">         &#125;</div><div class="line">         sql.append(<span class="string">')'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 创建一个 SQLiteStatment</span></div><div class="line">         SQLiteStatement statement = <span class="keyword">new</span> SQLiteStatement(<span class="keyword">this</span>, sql.toString(), bindArgs);</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// 调用 Statment 的 executeInsert() 方法</span></div><div class="line">             <span class="keyword">return</span> statement.executeInsert();</div><div class="line">         &#125; <span class="keyword">finally</span> &#123;</div><div class="line">             statement.close();</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         releaseReference();</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>这段代码这么长居然仅仅做了拼接 sql 语句的工作，其实其它的方法包括<code>update</code>和<code>delete</code>还有<code>executeSQL</code>都只是一个中间方法，他们都会创建一个<code>SQLiteStatment</code>并通过它来执行 SQL 语句，看到这里突然觉得很熟悉了，因为 JDBC 里也是这样O(∩_∩)O~</p>
<h2 id="SQLiteStatment"><a href="#SQLiteStatment" class="headerlink" title="SQLiteStatment"></a>SQLiteStatment</h2><p>再来看<code>SQLiteStatment</code>，这个类是<code>SQLiteProgram</code>的子类，<code>SQLiteProgram</code>比较简单，主要是封装了下面的一些信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SQLiteDatabase mDatabase; <span class="comment">// 对 SQLiteDatabase 的引用</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String mSql; <span class="comment">// 之前拼接好的字符串</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mReadOnly; <span class="comment">// 打开方式是只读还是可写</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] mColumnNames; <span class="comment">// column names</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mNumParameters; <span class="comment">// 参数个数，其值等于 column 数</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object[] mBindArgs; <span class="comment">// 提供的参数，如果其个数大于 mNumParameters 会报错</span></div></pre></td></tr></table></figure>
<p>接下来是<code>SQLiteStatment</code>中的一些代码，这段代码可以随意看看，注意他们都有一个共同点，就是都调用了<code>getSession()</code>方法，并调用这个<code>session</code>的<code>execute</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Execute this SQL statement, if it is not a SELECT / INSERT / DELETE / UPDATE, for example</div><div class="line">    * CREATE / DROP table, view, trigger, index etc.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@throws</span> android.database.SQLException If the SQL string is invalid for</div><div class="line">    *         some reason</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">       acquireReference();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           getSession().execute(getSql(), getBindArgs(), getConnectionFlags(), <span class="keyword">null</span>);</div><div class="line">       &#125; <span class="keyword">catch</span> (SQLiteDatabaseCorruptException ex) &#123;</div><div class="line">           onCorruption();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           releaseReference();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Execute this SQL statement, if the the number of rows affected by execution of this SQL</div><div class="line">    * statement is of any importance to the caller - for example, UPDATE / DELETE SQL statements.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@return</span> the number of rows affected by this SQL statement execution.</div><div class="line">    * <span class="doctag">@throws</span> android.database.SQLException If the SQL string is invalid for</div><div class="line">    *         some reason</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdateDelete</span><span class="params">()</span> </span>&#123;</div><div class="line">       acquireReference();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">return</span> getSession().executeForChangedRowCount(</div><div class="line">                   getSql(), getBindArgs(), getConnectionFlags(), <span class="keyword">null</span>);</div><div class="line">       &#125; <span class="keyword">catch</span> (SQLiteDatabaseCorruptException ex) &#123;</div><div class="line">           onCorruption();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           releaseReference();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Execute this SQL statement and return the ID of the row inserted due to this call.</div><div class="line">    * The SQL statement should be an INSERT for this to be a useful call.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@return</span> the row ID of the last row inserted, if this insert is successful. -1 otherwise.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@throws</span> android.database.SQLException If the SQL string is invalid for</div><div class="line">    *         some reason</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">executeInsert</span><span class="params">()</span> </span>&#123;</div><div class="line">       acquireReference();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">return</span> getSession().executeForLastInsertedRowId(</div><div class="line">                   getSql(), getBindArgs(), getConnectionFlags(), <span class="keyword">null</span>);</div><div class="line">       &#125; <span class="keyword">catch</span> (SQLiteDatabaseCorruptException ex) &#123;</div><div class="line">           onCorruption();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           releaseReference();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="SQLiteSession"><a href="#SQLiteSession" class="headerlink" title="SQLiteSession"></a>SQLiteSession</h2><p>那么这个<code>Session</code>又是何方神圣呢？<br><code>getSession()</code>在<code>SQLiteProgram</code>中是这样定义的，它调用了 SQLiteDatabase 的<code>getThreadSession()</code>方法。<br><strong>注意：这两个方法，一个是 protected，一个是包访问权限，他们都对外界隐藏！</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SQLiteStatment.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SQLiteSession <span class="title">getSession</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> mDatabase.getThreadSession();</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLiteDatabase.java</span></div><div class="line">   <span class="function">SQLiteSession <span class="title">getThreadSession</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> mThreadSession.get(); <span class="comment">// initialValue() throws if database closed</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>getThreadSession()</code>方法又是调用了<code>mThreadSession.get()</code>方法，<code>mThreadSession</code>如下定义，它通过<code>ThreadLocal</code>来保证每个线程中只有一个<code>SQLiteSession</code>对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Thread-local for database sessions that belong to this database.</span></div><div class="line"><span class="comment">// Each thread has its own database session.</span></div><div class="line"><span class="comment">// INVARIANT: Immutable.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;SQLiteSession&gt; mThreadSession = <span class="keyword">new</span> ThreadLocal&lt;SQLiteSession&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> SQLiteSession <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createSession();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>SQLiteSession</code>是<code>android.database.sqlite</code>包下的一个<code>public final</code>类，不知道为什么在谷歌的 API 文档里没有这个类的文档，只能看文件里的注释了。<br>我把文档注释保存成了 html 文档 <a href="http://oih52y89x.bkt.clouddn.com/SQLiteSession.html" target="_blank" rel="external"><strong>SQLiteSession Documentation</strong></a>。文档的大致翻译我写在了文章的最后  <a href="#translation"><strong>点此跳转</strong></a></p>
<p>通过这个文档我们知道，<code>SQLiteSession</code>是客户端与数据库交互的桥梁，现在我们来看看<code>SQLiteSession</code>中的<code>execute</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, Object[] bindArgs, <span class="keyword">int</span> connectionFlags,</span></span></div><div class="line">          CancellationSignal cancellationSignal) &#123;</div><div class="line">      <span class="keyword">if</span> (sql == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"sql must not be null."</span>);</div><div class="line">      &#125;</div><div class="line"><span class="comment">// 执行 BEGIN、COMMIT、ROLLBACK 等特殊操作</span></div><div class="line">      <span class="keyword">if</span> (executeSpecial(sql, bindArgs, connectionFlags, cancellationSignal)) &#123;</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line"><span class="comment">// 从 SQLConnectionPool 获取一个 SQLConnection</span></div><div class="line"><span class="comment">// 同时会增加一个引用计数</span></div><div class="line">      acquireConnection(sql, connectionFlags, cancellationSignal); <span class="comment">// might throw</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// 执行 SELECT、INSERT、UPDATE、DELETE 等操作</span></div><div class="line">          mConnection.execute(sql, bindArgs, cancellationSignal); <span class="comment">// might throw</span></div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// 减少一个引用计数，至0时释放连接</span></div><div class="line">          releaseConnection(); <span class="comment">// might throw</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="SQLiteConnection"><a href="#SQLiteConnection" class="headerlink" title="SQLiteConnection"></a>SQLiteConnection</h2><p>上面的代码调用了<code>SQLiteConnection</code>的<code>execute</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(String sql, Object[] bindArgs,</span></span></div><div class="line">          CancellationSignal cancellationSignal) &#123;</div><div class="line">      <span class="keyword">if</span> (sql == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"sql must not be null."</span>);</div><div class="line">      &#125;</div><div class="line"><span class="comment">// Operation 类用来描述一个操作，记录操作的类型、时间、异常、参数等</span></div><div class="line"><span class="comment">// 在操作开始前调用 beginOperation 方法，记录开始时间</span></div><div class="line"><span class="comment">// 操作结束后调用 endOperation 方法，记录结束时间</span></div><div class="line"><span class="comment">// 操作失败了调用 failOperation 方法，记录异常</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> cookie = mRecentOperations.beginOperation(<span class="string">"execute"</span>, sql, bindArgs);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">       <span class="comment">// 获取一个 PreparedStatment</span></div><div class="line">       <span class="comment">// 用了 LruCache 来缓存 PreparedStatment，用 sql 语句作为 key</span></div><div class="line">       <span class="comment">// 也就是说，如果是相同的 sql 语句（当然参数可以不同，即以'?'代表参数）</span></div><div class="line">       <span class="comment">// 系统自动就帮你复用之前的 PreparedStatment</span></div><div class="line">       <span class="comment">// 无需像 JDBC 里那样自己选择是否使用 PreparedStatment</span></div><div class="line">          <span class="keyword">final</span> PreparedStatement statement = acquirePreparedStatement(sql);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              throwIfStatementForbidden(statement);</div><div class="line">              <span class="comment">// 绑定参数，这里调用了本地方法</span></div><div class="line">              bindArguments(statement, bindArgs);</div><div class="line">              applyBlockGuardPolicy(statement);</div><div class="line">              attachCancellationSignal(cancellationSignal);</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// 执行这个 Statement</span></div><div class="line">               <span class="comment">// 这里是真的在执行了，交给 sqlite 驱动来完成</span></div><div class="line">                  nativeExecute(mConnectionPtr, statement.mStatementPtr);</div><div class="line">              &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                  detachCancellationSignal(cancellationSignal);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              releasePreparedStatement(statement);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">       <span class="comment">// 执行失败</span></div><div class="line">          mRecentOperations.failOperation(cookie, ex);</div><div class="line">          <span class="keyword">throw</span> ex;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">       <span class="comment">// 执行结束</span></div><div class="line">          mRecentOperations.endOperation(cookie);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>它创建了一个<code>PreparedStatment</code>，调用<code>bindArguments</code>方法来绑定参数，完成<code>PreparedStatment</code>的编译。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindArguments</span><span class="params">(PreparedStatement statement, Object[] bindArgs)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = bindArgs != <span class="keyword">null</span> ? bindArgs.length : <span class="number">0</span>;</div><div class="line">    <span class="comment">// 之前提到过如果 bindArgs 的个数和 mNumParameters 不相同就会抛出异常</span></div><div class="line">    <span class="keyword">if</span> (count != statement.mNumParameters) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLiteBindOrColumnIndexOutOfRangeException(</div><div class="line">                <span class="string">"Expected "</span> + statement.mNumParameters + <span class="string">" bind arguments but "</span></div><div class="line">                + count + <span class="string">" were provided."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> statementPtr = statement.mStatementPtr;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        <span class="keyword">final</span> Object arg = bindArgs[i];</div><div class="line">        <span class="comment">// 这里调用 DatabaseUtils 的 getTypeOfObject 方法来判断 arg 的类型</span></div><div class="line">        <span class="comment">// getTypeOfObject 方法的代码见下文</span></div><div class="line">        <span class="comment">// 得到参数的类型后，调用 native 方法来完成绑定</span></div><div class="line">        <span class="keyword">switch</span> (DatabaseUtils.getTypeOfObject(arg)) &#123;</div><div class="line">            <span class="keyword">case</span> Cursor.FIELD_TYPE_NULL:</div><div class="line">                nativeBindNull(mConnectionPtr, statementPtr, i + <span class="number">1</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Cursor.FIELD_TYPE_INTEGER:</div><div class="line">                nativeBindLong(mConnectionPtr, statementPtr, i + <span class="number">1</span>,</div><div class="line">                        ((Number)arg).longValue());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Cursor.FIELD_TYPE_FLOAT:</div><div class="line">                nativeBindDouble(mConnectionPtr, statementPtr, i + <span class="number">1</span>,</div><div class="line">                        ((Number)arg).doubleValue());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Cursor.FIELD_TYPE_BLOB:</div><div class="line">                nativeBindBlob(mConnectionPtr, statementPtr, i + <span class="number">1</span>, (<span class="keyword">byte</span>[])arg);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> Cursor.FIELD_TYPE_STRING:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> Boolean) &#123;</div><div class="line">                    <span class="comment">// Provide compatibility with legacy applications which may pass</span></div><div class="line">                    <span class="comment">// Boolean values in bind args.</span></div><div class="line">                    nativeBindLong(mConnectionPtr, statementPtr, i + <span class="number">1</span>,</div><div class="line">                            ((Boolean)arg).booleanValue() ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    nativeBindString(mConnectionPtr, statementPtr, i + <span class="number">1</span>, arg.toString());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="DatabaseUtils-和-Cursor-接口（不重要）"><a href="#DatabaseUtils-和-Cursor-接口（不重要）" class="headerlink" title="DatabaseUtils 和 Cursor 接口（不重要）"></a>DatabaseUtils 和 Cursor 接口（不重要）</h2><p><code>DataBaseUtils</code>里的<code>getTypeOfObject</code>方法如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTypeOfObject</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line"> <span class="comment">// 通过 instanceof 运算符来判断类型</span></div><div class="line"> <span class="comment">// 分别对应 SQLite 里的 NULL、BLOB、INTEGER、REAL、TEXT 类型</span></div><div class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> Cursor.FIELD_TYPE_NULL;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="keyword">byte</span>[]) &#123;</div><div class="line">        <span class="keyword">return</span> Cursor.FIELD_TYPE_BLOB;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Float || obj <span class="keyword">instanceof</span> Double) &#123;</div><div class="line">        <span class="keyword">return</span> Cursor.FIELD_TYPE_FLOAT;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Long || obj <span class="keyword">instanceof</span> Integer</div><div class="line">            || obj <span class="keyword">instanceof</span> Short || obj <span class="keyword">instanceof</span> Byte) &#123;</div><div class="line">        <span class="keyword">return</span> Cursor.FIELD_TYPE_INTEGER;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> Cursor.FIELD_TYPE_STRING;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对应的一些 TYPE 常量定义在<code>Cursor</code>接口中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Values returned by &#123;@link #getType(int)&#125;.</div><div class="line"> * These should be consistent with the corresponding types defined in CursorWindow.h</div><div class="line"> */</div><div class="line"><span class="comment">/** Value returned by &#123;<span class="doctag">@link</span> #getType(int)&#125; if the specified column is null */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD_TYPE_NULL = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">/** Value returned by &#123;<span class="doctag">@link</span> #getType(int)&#125; if the specified  column type is integer */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD_TYPE_INTEGER = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">/** Value returned by &#123;<span class="doctag">@link</span> #getType(int)&#125; if the specified column type is float */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD_TYPE_FLOAT = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="comment">/** Value returned by &#123;<span class="doctag">@link</span> #getType(int)&#125; if the specified column type is string */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD_TYPE_STRING = <span class="number">3</span>;</div><div class="line"></div><div class="line"><span class="comment">/** Value returned by &#123;<span class="doctag">@link</span> #getType(int)&#125; if the specified column type is blob */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIELD_TYPE_BLOB = <span class="number">4</span>;</div></pre></td></tr></table></figure>
<p>可以看出，<code>DatabaseUtils</code>是通过<code>instanceof</code>运算符来判断类型的，<code>byte[]</code>被当做 BLOB 类型，<code>Float</code>和<code>Double</code>都被当做 FLOAT 类型（应该是 SQLite 里的 REAL 类型），<code>Long</code>、<code>Integer</code>、<code>Short</code>和<code>Byte</code>都被当做 INTEGER 类型，其它的都是 STRING 类型（即 SQLite 里的 TEXT 类型）。</p>
<h2 id="PreparedStatment"><a href="#PreparedStatment" class="headerlink" title="PreparedStatment"></a>PreparedStatment</h2><p><code>PreparedStatment</code>只是一个对<code>native</code>对象的绑定，逻辑是在<code>native</code>层实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Holder type for a prepared statement.</div><div class="line">  *</div><div class="line">  * Although this object holds a pointer to a native statement object, it</div><div class="line">  * does not have a finalizer.  This is deliberate.  The &#123;<span class="doctag">@link</span> SQLiteConnection&#125;</div><div class="line">  * owns the statement object and will take care of freeing it when needed.</div><div class="line">  * In particular, closing the connection requires a guarantee of deterministic</div><div class="line">  * resource disposal because all native statement objects must be freed before</div><div class="line">  * the native database object can be closed.  So no finalizers here.</div><div class="line">  */</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PreparedStatement</span> </span>&#123;</div><div class="line">     <span class="comment">// Next item in pool.</span></div><div class="line">     <span class="keyword">public</span> PreparedStatement mPoolNext;</div><div class="line"></div><div class="line">     <span class="comment">// The SQL from which the statement was prepared.</span></div><div class="line">     <span class="keyword">public</span> String mSql;</div><div class="line"></div><div class="line">     <span class="comment">// The native sqlite3_stmt object pointer.</span></div><div class="line">     <span class="comment">// Lifetime is managed explicitly by the connection.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">long</span> mStatementPtr;</div><div class="line"></div><div class="line">     <span class="comment">// The number of parameters that the prepared statement has.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">int</span> mNumParameters;</div><div class="line"></div><div class="line">     <span class="comment">// The statement type.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">int</span> mType;</div><div class="line"></div><div class="line">     <span class="comment">// True if the statement is read-only.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">boolean</span> mReadOnly;</div><div class="line"></div><div class="line">     <span class="comment">// True if the statement is in the cache.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">boolean</span> mInCache;</div><div class="line"></div><div class="line">     <span class="comment">// True if the statement is in use (currently executing).</span></div><div class="line">     <span class="comment">// We need this flag because due to the use of custom functions in triggers, it's</span></div><div class="line">     <span class="comment">// possible for SQLite calls to be re-entrant.  Consequently we need to prevent</span></div><div class="line">     <span class="comment">// in use statements from being finalized until they are no longer in use.</span></div><div class="line">     <span class="keyword">public</span> <span class="keyword">boolean</span> mInUse;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h1 id="小结（附图）"><a href="#小结（附图）" class="headerlink" title="小结（附图）"></a>小结（附图）</h1><p>以<code>SQLiteDatabase</code>的<code>insert</code>操作为例，不废话，直接上图。（ps: 图片略长，可以右键查看原图。）<br><img src="http://oih52y89x.bkt.clouddn.com/sqlite1.png" alt="@SQLiteDatabase insert 的执行流程| center"></p>
<p><div id="translation"></div></p>
<h1 id="SQLiteSession-Documentation-翻译"><a href="#SQLiteSession-Documentation-翻译" class="headerlink" title="SQLiteSession Documentation 翻译"></a>SQLiteSession Documentation 翻译</h1><h2 id="关于数据库的会话"><a href="#关于数据库的会话" class="headerlink" title="关于数据库的会话"></a>关于数据库的会话</h2><p>与数据库的交互是通过 session 来执行的。Session 可以执行只读操作和读写操作。如果不执行写入操作，最好以只读方式打开一个 session ，这样数据库连接池可以优化数据库连接的分配，从而使多个只读操作可以并行执行，而读写操作就只能是串行的。</p>
<h2 id="所有权和并发保证"><a href="#所有权和并发保证" class="headerlink" title="所有权和并发保证"></a>所有权和并发保证</h2><p>Session 对象不是线程安全的，所以用上面的方式，确保每个线程都有他们各自的 session 对象。一个线程至多含有一个数据库对象，这个约束保证了一个线程绝不会同时占用这个数据库的多个连接。由于数据库连接是有限的，如果一个线程尝试同时获得多个连接可能会导致死锁，因此只允许一个线程至多有一个会话（连接）。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>事务（Transaction）有两种，隐式事务和显式事务。任何一个非显式事务的数据库操作，都会创建一个隐式事务，它会在操作成功后马上提交（commit）。显式事务通过<code>beginTransaction()</code>方法创建，一旦一个显式事务被创建，一系列的子操作会被当做这个事务的一部分来执行。结束一个事务的时候，如果事务成功，首先应该调用<code>setTransactionSuccessful()</code>，然后再调用<code>endTransaction()</code>。如果事务被标记为成功，它就会被提交，否则回滚（rolled back）。显式事务也可以嵌套，如果任何一个子事务没有被标记为成功，整个事务都会在最外层事务结束的时候回滚。为了提高并发性，一个显式事务可以通过调用<code>yieldTransaction()</code>来放弃执行权。如果这时有竞争使用数据库的情况，yield 会结束当前事务，提交已经完成的操作，释放数据库连接给另一个会话使用一段时间，然后又会开始一个和原事务有相同属性的事务。因为 yield 而提交的改变不能被滚回。当事务开始的时候，客户端可以提供一个<code>SQLiteTransactionListener</code>来监听事务有关的通知。<br>推荐的使用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// First, begin the transaction.</span></div><div class="line">session.beginTransaction(SQLiteSession.TRANSACTION_MODE_DEFERRED, <span class="number">0</span>);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// Then do stuff...</span></div><div class="line">    session.execute(<span class="string">"INSERT INTO ..."</span>, <span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// As the very last step before ending the transaction, mark it successful.</span></div><div class="line">    session.setTransactionSuccessful();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="comment">// Finally, end the transaction.</span></div><div class="line">    <span class="comment">// This statement will commit the transaction if it was marked successful or</span></div><div class="line">    <span class="comment">// roll it back otherwise.</span></div><div class="line">    session.endTransaction();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数据库连接"><a href="#数据库连接" class="headerlink" title="数据库连接"></a>数据库连接</h2><p>一个<code>SQLDatabase</code>可以同时有多个活动的会话，每个会话在请求数据库的时候都必须获得和释放数据库连接，如果所有连接都被占用，一些会话的事务就会被阻塞直到有可用的连接。<br>一个会话仅在开始事务的时候获得一个连接，事务结束后必须释放。这一特性允许一个有限的数据库连接池里的连接被多个会话高效的共享，只要他们不是全部都在同一时间执行数据库事务。</p>
<h2 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h2><p>由于数据库连接是有限的，而一个会话会在执行一整个事务的时间内占用一个连接，保持事务有一个较小的规模非常重要。尤其是执行读写操作的事务，因为他们会阻塞其它的事务执行。执行一个耗时事务的时候，考虑每隔一段时间使用<code>yieldTransaction</code>。<br>另一个非常重要的方面是，事务占用太多时间可能导致 UI 线程无响应。即使事务是在后台执行，用户也会很反感事务执行的那几秒里空荡荡的 UI 界面。</p>
<h2 id="可重入（Reentrance）"><a href="#可重入（Reentrance）" class="headerlink" title="可重入（Reentrance）"></a>可重入（Reentrance）</h2><p>这个类必须容忍重入性的 SQLite 操作调用，因为触发器有可能调用自定义的 SQLite 函数来执行额外的查询。<br>这句话啥意思呢，就是说这个类里的方法必须满足可重入性，就是在一个方法还没执行完毕的时候，它可以被再次调用，且不影响先前的结果。造成这种情况的可能原因是你自定义了一个触发器，它在触发的时候又调用了这个方法。</p>
<h1 id="（未完待续～）"><a href="#（未完待续～）" class="headerlink" title="（未完待续～）"></a>（未完待续～）</h1>

            
            <div class="post-reward">
                <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
            </div>
            
            
            <blockquote>
                <p>
                本文地址：
                <a href="http://WqyJh.github.io/2016/12/22/Android-SQLite-源码分析/" target="_blank" rel="external">http://WqyJh.github.io/2016/12/22/Android-SQLite-源码分析/</a>
                </p>
                <footer><cite><a href="http://WqyJh.github.io">@Wqy's Home Page</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2016/12/20/设计模式/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">设计模式</h4>
      </a>
    </div>
  
</nav>


            
            



        </div>
    </div>
</article>
    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "Android SQLite 源码分析",
    pic: "/img/logo.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://WqyJh.github.io/2016/12/22/Android-SQLite-源码分析/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>




<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.jpg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>

<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>





<script src="//s95.cnzz.com/z_stat.php?id=1260528788&web_id=1260528788"></script>





<script type="text/javascript">
  var msg_desc = document.getElementsByName('summary')[0].content;
</script>
</body>
</html>
